{% extends "base.html" %}

{% block title %}API Keys - MSSQL to dbt Migration{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">API Keys</h1>
        <a href="{{ url_for('api_keys.new_api_key') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            New API Key
        </a>
    </div>

    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        {% if api_keys %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate Limit</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Used</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for api_key in api_keys %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ api_key.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        <span class="inline-flex items-center">
                            <span id="key-{{ api_key.id }}">{{ api_key.key[:10] }}...{{ api_key.key[-10:] }}</span>
                            <button onclick="copyKey('{{ api_key.key }}')" class="ml-2 text-blue-600 hover:text-blue-900">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if api_key.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {% if api_key.is_active %}Active{% else %}Revoked{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ api_key.rate_limit }}/hour</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ api_key.created_at.strftime('%Y-%m-%d') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ api_key.last_used.strftime('%Y-%m-%d %H:%M') if api_key.last_used else 'Never' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if api_key.is_active %}
                        <form method="POST" action="{{ url_for('api_keys.revoke_api_key', key_id=api_key.id) }}" style="display:inline;">
                            <button type="submit" onclick="return confirm('Revoke this API key?')" class="text-red-600 hover:text-red-900">
                                Revoke
                            </button>
                        </form>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="px-6 py-12 text-center">
            <p class="text-gray-500">No API keys yet. Create your first API key to access the FastAPI endpoints!</p>
        </div>
        {% endif %}
    </div>

    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-md p-4">
        <h3 class="text-sm font-medium text-blue-900 mb-2">How to use API keys:</h3>
        <ol class="list-decimal list-inside text-sm text-blue-800 space-y-1">
            <li>Create a new API key above</li>
            <li>Copy the key (you won't be able to see it again)</li>
            <li>Use it in your API requests: <code class="bg-blue-100 px-1 rounded">Authorization: Bearer YOUR_API_KEY</code></li>
        </ol>
    </div>
</div>

<script>
function copyKey(key) {
    navigator.clipboard.writeText(key).then(() => {
        alert('API key copied to clipboard!');
    });
}
</script>
{% endblock %}
